{% extends 'base.html.twig' %}

{% block title %}Pedidos | UMAD{% endblock %}

{% block body %}
  <div class="gradient-bg">
    <div class="container w-100 h-100" id="orders-div">
      <div class="w-100 h-100 d-flex flex-column mt-3">
        <div class="d-flex justify-content-between align-items-center" style="margin-top:3.5rem; margin-bottom:1.5rem;">
          <div class="d-flex flex-column gap-1">
            <h3 class="mb-0">Historial de pedidos</h3>
            <p class="text-secondary mb-0" style="font-size: .9rem">Detalle de pedidos pertenecientes al centro de salud: <a href="{{ path('app_health_index', {'healthcenter' : app.user.getHealthCenter() }) }}">{{app.user.getHealthCenter()}}</a>.</p>
          </div>
          <div>
          <a href="{{ path('app_order_new') }}" class="btn btn-primary p-1"><i class="fa-solid fa-plus"></i> Pedido</a>
          </div>
        </div>
        <div class="table-responsive bg-white rounded-2 border p-3 overflow-hidden" style="height:66%; max-height:66%">
          <table class="table table-hover mw-100">
            <thead>
              <tr style="font-size:.9rem">
                <th scope="col">#</th>
                <th class="">{{ knp_pagination_sortable(pagination, 'Creado', 'a.createdAt') }}</th>
                <th scope="col" class="memo-cell">Memo</th>
                <th scope="col">Usuario</th>
                <th  class="">{{ knp_pagination_sortable(pagination, 'Estado', 'e.description') }}</th>
                <th scope="col">Ver orden</th>
              </tr>
            </thead>
            <div id="notification"></div>
            {% if pagination %}
              <tbody id="table-body">
                {% for order in pagination %} 
                  <tr style="font-size:0.85rem">
                    <td class="fw-light">{{ order.id }}</td>
                    <td class="fw-light">{{ order.createdAt | date("d/m/y h:i") }}</td>
                    <td class="fw-light memo-cell">{{ order.memo ? (order.memo|length > 50 ? order.memo|slice(0,50) ~ '...' : order.memo) : ('No se especificó memo') }}</td>
                    <td class="fw-light">{{ order.username }} {{order.userlastname}}</td>
                    <td class="fw-light">{{ order.status == 'Recibido' ? 'Enviado' : order.status}}</td>
                    <td>
                      <div class="d-flex gap-2 align-items-center">
                        <a href="{{ path('app_order_show', {'id': order.id}) }}" class="d-flex text-dark">Ver</a>
                        <a href="{{ path('pedidos_pdf', {'id': order.id}) }}" class="btn btn-outline-dark ps-1 pe-1 pt-0 pb-0 rounded-1" style="font-size:.8rem"><i class="fa-solid fa-arrow-down"></i> PDF</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
              {% else %}
                <p>No se encontró ningún pedido. Puede ser que no se haya realizado ninguno o que no hay pedidos que cumplan con el filtro.</p>
              {% endif %}
          </table>
        </div>
        <div class="d-flex justify-content-between mt-2">
        <div class="d-flex flex-column text-secondary pb-0" style="font-size: .85rem;">
          <div class="d-flex align-items-center gap-2">
            <i class="dot"></i>
            <p class="mb-0">Ayuda:</p>
          </div>
          <p class="mb-0 ms-3">- En caso de querer cancelar un pedido, contactar con la administradora y solicitar un pedido nuevo.</p>
          <p class="mb-0 ms-3">- Por cuestiones de integridad de la información, no es posible editar los pedidos.</p>
        </div>
        {{knp_pagination_render(pagination)}}
        </div> 
      </div>
    </div>
  </div>

  {# {% block javascripts %}
    {{ parent() }}
       <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
      <script>
        // Funcion de filtro de pedidos basado en un Id que se triggerea con un botón y envía un id a mano.
        function getFilteredOrders(id){
          fetch(`/pedidos/filtrar/${id}`)
          .then(response => response.json())
          .then(data => {
              const filteredOrdersDiv = document.getElementById('table-body');
              const notification = document.getElementById('notification');
              filteredOrdersDiv.innerHTML='';
              // Code to display the list of data goes here
              if(data.length > 0){
                data.forEach(order => {
                  filteredOrdersDiv.innerHTML+=`<tr style="font-size:0.85rem"><td class="fw-light">${order.id}</td><td class="fw-light">${moment(order.created_at.date.slice(0,16)).format('DD/MM/YY hh:mm')}</td><td class="fw-light">${order.memo ? (order.memo.length>50 ? (order.memo.slice(0,47) + "...") : (order.memo) ) : ('No se especificó memo') }</td><td class="fw-light">${order.user}</td><td class="fw-light">${order.status == 'Recibido' ? 'Enviado' : order.status}</td><td><a href="/pedidos/${order.id}">ver</a></td></tr>`
                });
                console.log(data)
              } else {
                notification.innerHTML = '<p>No se encontró ningún pedido. Puede ser que no se haya realizado ninguno o que no hay pedidos que cumplan con el filtro.</p>'
              }
              
          })
          .catch(error => {
              console.error('Error fetching orders list:', error);
          });
        } 
      </script>
  {% endblock %}
#}
{% endblock %}